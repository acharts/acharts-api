<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
 *
 * @line图的tag
 *
 * */

var
    Cartesian = require(&#39;./cartesian&#39;),
    Util = require(&#39;../../util&#39;);

function trySet(obj,name,value){
    if(obj &amp;&amp; !obj[name]){
        obj[name] = value;
    }
}

<span id='Chart-Series-Flag'>/**
</span> * @class Chart.Series.Flag
 * 使用线连接数据的数据图序列
 * @extends Chart.Series.Cartesian
 */
function Flag(cfg){
    Flag.superclass.constructor.call(this,cfg);
}

Util.extend(Flag,Cartesian);

Flag.ATTRS = {

    type : &#39;flag&#39;,
    elCls : &#39;x-chart-flag-series&#39;,
    zIndex: 6,
<span id='Chart-Series-Flag-property-flag'>    /**
</span>     * 配置
     * @type {Object}
     */
    flag : null,

<span id='Chart-Series-Flag-property-distance'>    /**
</span>     * y偏离
     * @type {Number}
     */
    distance: 0,

<span id='Chart-Series-Flag-property-line'>    /**
</span>     * 笔触
     * @type {Object}
     */
    line: null,

<span id='Chart-Series-Flag-property-custom'>    /**
</span>     * 使用html
     * @type {bool}
     */

    custom: false,

<span id='Chart-Series-Flag-property-title'>    /**
</span>     * 使用html时候的内容
     * @type {String}
     */

    title: null

};

Util.augment(Flag,{
<span id='Chart-Series-Flag-method-_getPoints'>    /**
</span>     *  重写获取point函数
     */
    _getPoints : function(){
        var _self = this,
            data = _self.get(&#39;data&#39;),
            xField = _self.get(&#39;xField&#39;),
            yField = _self.get(&#39;yField&#39;),
            onSeries = _self.get(&#39;onSeries&#39;),
            parent = _self.get(&#39;parent&#39;),
            distance = _self.get(&#39;distance&#39;),
            series = parent.find(onSeries),
            flagAttrs = _self.get(&#39;flag&#39;),
            lineAttrs = _self.get(&#39;line&#39;),
            xAxis = _self.get(&#39;xAxis&#39;),
            yAxis = _self.get(&#39;yAxis&#39;),
            points = [];

        cfg = Util.mix({},flagAttrs,lineAttrs);
        Util.each(data,function(item,index){
            var point,sameNum = 0;
            if(Util.isObject(item)){
                var xValue = item[xField];

                //不存在落点线条 则落到坐标轴上面
                if(!series || !series.get(&#39;visible&#39;)){
                    var _x = xAxis.getOffset(xValue),
                        _y = yAxis.getStartOffset();

                    point = {
                        x: _x,
                        y: _y,
                        xValue: xValue
                    }
                }
                else{
                    point = series.findPointByValue(xValue);
                }

                if(!point) return true;

                //若存在坐标轴一样的flag  往上堆叠
                Util.each(data,function(newItem,newIndex){
                    if(newIndex &lt; index &amp;&amp; item[xField] == newItem[xField]){
                        sameNum ++;
                    }
                })

                var finalDistance = distance &gt; 0 ? (distance * (sameNum + 1) + cfg.r * 2 * sameNum) : (distance * (sameNum + 1) - cfg.r * 2 * sameNum);
                point = Util.mix({},point,{
                    y: point.y + finalDistance,
                    index: sameNum
                });

                point.obj = item;
            }
            _self.processPoint(point,index);
            points.push(point);
        });

        return points;
    },
<span id='Chart-Series-Flag-method-changeShapes'>    /**
</span>     *  重写legend导致的画面变动
     */
    changeShapes : function(points,animate){
        var _self = this,
            flagAttrs = _self.get(&#39;flag&#39;),
            lineAttrs = _self.get(&#39;line&#39;),
            cfg = Util.mix({},flagAttrs,lineAttrs),
            custom = _self.get(&#39;custom&#39;),
            distance = _self.get(&#39;distance&#39;),
            groups = _self.get(&#39;children&#39;);

        points = points || this._getPoints();

        if(custom){
            var customDiv = _self.get(&#39;customDiv&#39;);
            if(customDiv){
                Util.each(customDiv.childNodes,function(flag,index){
                    var point = points[index];

                    if(!point){
                        flag.style.display = &quot;none&quot;;
                        return true;
                    }

                    var flagWidth = Util.getWidth(flag),
                        x = point.x,
                        y = point.y,
                        flagHeight = Util.getHeight(flag),
                        left = x - flagWidth/2,
                        top = y + distance - flagHeight/2;

                    flag.style.cssText = &quot;z-index:5;position:absolute;left:&quot;+ left +&quot;px;top:&quot;+ top +&quot;px&quot;;
                });
                /*Util.each(points,function(point,index){
                 var flag = customDiv.childNodes[index],
                 flagWidth = Util.getWidth(flag),
                 x = point.x,
                 y = point.y,
                 flagHeight = Util.getHeight(flag),
                 left = x - flagWidth/2,
                 top = y + distance - flagHeight/2
                 flag.style.cssText = &quot;z-index:5;position:absolute;left:&quot;+ left +&quot;px;top:&quot;+ top +&quot;px&quot;;
                 });*/
            }
        }else{
            if(groups){
                Util.each(groups,function(group,index){

                    var point = points[index];

                    if(!point){
                        group.hide();
                        return true;
                    }

                    var x = point.x,
                        y = point.y,
                        shapes = group.get(&#39;children&#39;),
                        circle = shapes[0],line = shapes[1];

                    circle.attr({
                        cx: x,
                        cy: distance &gt; 0 ? (y + cfg.r) : (y - cfg.r)
                    });
                    line.attr({
                        x1: x,
                        y1: y,
                        x2: x,
                        y2: y - distance
                    });

                    group.show();
                });
            }
        }
    },
    draw : function(points,callback){
        var _self = this,
            animate = _self.get(&#39;animate&#39;),
            duration = _self.get(&#39;duration&#39;);

        if(!animate) {
            Util.each(points, function (item, index) {
                _self._drawShape(item, index);
            });

            _after();
        }else{
            var onSeries = _self.get(&#39;onSeries&#39;),
                parent = _self.get(&#39;parent&#39;);

            var seriesPoints = _self._getPoints();

            var cur = 0,
                sub = [],
                count = seriesPoints.length;

            //动画生成线和对应的点
            Util.animStep(duration,function(factor){
                var pre = cur;
                cur = parseInt((factor) * count,10);
                if(cur &gt; count - 1){
                    cur = count - 1;
                }

                if(cur != pre){
                    sub = points.slice(0,cur + 1);
                    for(var i = pre; i&lt; cur; i++){
                        _findFlagToDraw(seriesPoints[i]);
                    }
                }
                if(factor == 1){
                    _findFlagToDraw(seriesPoints[cur]);
                }
            },_after);
        }

        function _after(){
            _self.bindFlagEvent();
            callback &amp;&amp; callback();
        }

        function _findFlagToDraw(currPoint){
            Util.each(points, function (item, index) {
                if(item.x == currPoint.x &amp;&amp; !item.isDraw){
                    _self._drawShape(item, index);
                    item.isDraw = true; //防止堆叠时候x值相同而重复画
                }
            });
        }

    },
<span id='Chart-Series-Flag-method-_drawShape'>    /**
</span>     *  根据点绘制
     */
    _drawShape: function(point,index){
        var _self = this,
            flagAttrs = _self.get(&#39;flag&#39;),
            lineAttrs = _self.get(&#39;line&#39;),
            custom = _self.get(&#39;custom&#39;),
            x = point.x,
            y = point.y,
            distance = _self.get(&#39;distance&#39;),
            flagShape = _self.get(&#39;flagShape&#39;),
            cfg = Util.mix({},flagAttrs,lineAttrs);

        //自定义html
        if(custom){
            var title = _self.get(&#39;data&#39;)[index][&#39;html&#39;] || _self.get(&#39;html&#39;),
                html = &#39;&lt;div class=&quot;ac-flags&quot;&gt;&lt;/div&gt;&#39;,
                flag = Util.createDom(&quot;&lt;span&gt;&quot; + title + &quot;&lt;/span&gt;&quot;),
                outterNode = _self.get(&#39;canvas&#39;).get(&#39;node&#39;).parentNode,
                customDiv = _self.get(&#39;customDiv&#39;);

            outterNode.style.position = &#39;relative&#39;;

            //判断是否存在 不存在则追加并绑定事件
            if(!customDiv){
                customDiv = Util.createDom(html);
                outterNode.appendChild(customDiv);

                _self.bindTooltip(customDiv);
                _self.bindDomEvent(customDiv);

            }
            customDiv.appendChild(flag);
            var flagWidth = Util.getWidth(flag),
                flagHeight = Util.getHeight(flag),
                left = x - flagWidth/2,
                top = y + distance - flagHeight/2
            flag.style.cssText = &quot;z-index:5;position:absolute;left:&quot;+ left +&quot;px;top:&quot;+ top +&quot;px&quot;;

            _self.set(&#39;customDiv&#39;,customDiv);
        }else{

            var group = _self.addGroup();
            //circle
            cfg = Util.mix(cfg,{
                cx: x,
                cy: distance &gt; 0 ? (y + cfg.r) : (y - cfg.r)
            });
            group.addShape(&#39;circle&#39;,cfg);

            //line
            cfg = Util.mix(cfg,{
                x1: x,
                y1: y,
                x2: x,
                y2: y - distance
            });
            group.addShape(&#39;line&#39;,cfg);

            //用于changeShape时候对应points和group，不使用index的原因是考虑到stock chart
            console.log(point)
            group.set(&#39;xValue&#39;,point.xValue);
            group.set(&#39;index&#39;,point.index);
        }
    },
<span id='Chart-Series-Flag-method-bindFlagEvent'>    /**
</span>     * 开放事件接口
     */
    bindFlagEvent: function(){
        var _self = this;

        _self.on(&#39;click&#39;,function(ev){
            _self.fireUp(&#39;flagclick&#39;,ev);
        });
        _self.on(&#39;mouseover&#39;,function(ev){
            _self.fireUp(&#39;flagmouseover&#39;,ev);
        });
        _self.on(&#39;mouseout&#39;,function(ev){
            _self.fireUp(&#39;flagmouseout&#39;,ev);
        });
    },
<span id='Chart-Series-Flag-method-bindTooltip'>    /**
</span>     *  自定义事件时，添加tooltip
     */
    bindTooltip: function(element){
        var _self = this,
            parent = _self.get(&#39;parent&#39;);

        Util.addEvent(element,&#39;mouseover&#39;,function(){
            if(parent.setActivedItem){
                if(!parent.isItemActived(_self)){
                    parent.setActivedItem(_self);
                }
            }
        });
    },
<span id='Chart-Series-Flag-method-bindDomEvent'>    /**
</span>     * 自定义flag开放事件接口
     */
    bindDomEvent: function(element){
        var _self = this;
        Util.addEvent(element,&#39;click&#39;,function(ev){
            _self.fireUp(&#39;flagclick&#39;,ev);
        });
        Util.addEvent(element,&#39;mouseover&#39;,function(ev){
            _self.fireUp(&#39;flagmouseover&#39;,ev);
        });
        Util.addEvent(element,&#39;mouseout&#39;,function(ev){
            _self.fireUp(&#39;flagmouseout&#39;,ev);
        });
    },
<span id='Chart-Series-Flag-method-show'>    /**
</span>     * 显示
     */
    show : function(){
        var _self = this,
            customDiv = _self.get(&#39;customDiv&#39;);
        _self.get(&#39;el&#39;).show();
        _self.set(&#39;visible&#39;,true);

        if(customDiv){
            customDiv.style.display = &#39;block&#39;;
        }
    },
<span id='Chart-Series-Flag-method-hide'>    /**
</span>     * 隐藏
     */
    hide : function(){
        var _self = this,
            customDiv = _self.get(&#39;customDiv&#39;);
        _self.get(&#39;el&#39;).hide();
        _self.set(&#39;visible&#39;,false);

        if(customDiv){
            customDiv.style.display = &#39;none&#39;;
        }
    }
});

module.exports = Flag;</pre>
</body>
</html>
